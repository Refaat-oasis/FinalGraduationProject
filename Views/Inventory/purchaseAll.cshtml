@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@model ThothSystemVersion1.DataTransfereObject.purchaseOrderDTO

@{
    Layout = null;
    ViewBag.Title = "طلب شراء";
    var vendors = ViewBag.vendorList as List<Vendor>;
    var papers = ViewBag.PaperList;
    var inks = ViewBag.InkList;
    var supplies = ViewBag.SupplyList;
    var sparepart = ViewBag.sparePartList;

    int jobRole = HttpContextAccessor.HttpContext.Session.GetInt32("JobRole") ?? 0;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="~/css/Inventory/purchaseAll.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body>
    <div class="arrow">
        @if (jobRole == 0)
        {
            <a asp-controller="employee" asp-action="adminhome" class="back">
                <i class='bx bx-left-arrow-circle' style="font-size:40px;color:white"></i>
            </a>
        }
        else if (jobRole == 1)
        {
            <a asp-controller="employee" asp-action="InventoryManager" class="back">
                <i class='bx bx-left-arrow-circle' style="font-size:40px;color:white"></i>
            </a>
        }
        else if (jobRole == 2)
        {
            <a asp-controller="employee" asp-action="InventoryClerk" class="back">
                <i class='bx bx-left-arrow-circle' style="font-size:40px;color:white"></i>
            </a>
        }
    </div>

    <div class="form-container">
        <h1>إضافة طلب شراء</h1>

        @* Success/Error Notifications *@
        @if (TempData["Success"] != null)
        {
            <div class="notification success">
                <div class="notification-content"><i class='bx bx-check-circle'></i> @TempData["Success"]</div>
                <input type="hidden" id="tempDataSuccess" value="true" />
                <div class="progress-bar success"></div>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="notification error">
                <div class="notification-content"><i class='bx bx-error-circle'></i> @TempData["Error"]</div>
                <input type="hidden" id="tempDataSuccess" value="false" />
                <div class="progress-bar error"></div>
            </div>
        }
        <input type="hidden" id="hdnJobRole" value="@jobRole" />

        <form asp-controller="Inventory" asp-action="purchaseall" method="post">
            <div class="rowCont">
                <div class="colCont">
                    <label asp-for="PurchaseNotes" class="form-label">ملاحظات عن الشراء</label>
                    <textarea asp-for="PurchaseNotes" class="form-control" rows="2" placeholder="أدخل أي ملاحظات هنا..."></textarea>
                </div>
                <div class="colCont">
                    <label asp-for="VendorId" class="form-label">التاجر</label>
                    <select asp-for="VendorId" class="form-select" asp-items="@(new SelectList(vendors, "VendorId", "VendorName"))">
                        <option value="">-- اختر التاجر --</option>
                    </select>
                </div>
            </div>

            <div class="title">
                <h3>إضافة عنصر</h3>
            </div>

            <div class="rowCont">
                <div class="colCont" id="priceFieldDiv">
                    <label class="form-label">السعر</label>
                    <input type="number" id="itemPrice" class="form-control" min="0" step="0.01" />
                </div>
                <div class="colCont" id="quantityFieldDiv">
                    <label class="form-label">الكمية</label>
                    <input type="number" id="itemQuantity" class="form-control" min="0" />
                </div>

                <div class="colCont" id="unitsFieldDiv" style="display:none;">
                    <label class="form-label">عدد الوحدات</label>
                    <input type="number" id="NumberOfUnits" class="form-control" min="0" />
                </div>

                <div class="colCont">
                    <label class="form-label">العنصر</label>
                    <select id="itemId" class="form-select" disabled>
                        <option value="">-- اختر العنصر --</option>
                    </select>
                </div>

                <div class="colCont">
                    <label class="form-label">نوع العنصر</label>
                    <select id="itemType" class="form-select">
                        <option value="">-- اختر نوع العنصر --</option>
                        <option value="Paper">ورق</option>
                        <option value="Ink">حبر</option>
                        <option value="Supply">مستلزمات</option>
                        <option value="sparePart">قطع غيار</option>
                    </select>
                </div>

                <div class="colCont">
                    <button type="button" id="addItem" class="btn1">أضف العنصر</button>
                </div>

            </div>

            <div class="tableContainer1">
                <table class="mainTable">
                    <thead>
                        <tr>
                            <th>العنصر</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>عدد الوحدات</th>
                            <th>الإجراءات</th>

                        </tr>
                    </thead>
                    <tbody id="itemsTableBody" class="tableRow"></tbody>
                </table>
            </div>

            <div id="hiddenItemsContainer"></div>
            <div class="colCont1"><button type="submit" class="btn1">إرسال الطلب</button></div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function() {
            var items = [], editIndex = -1;
            const dataSources = {
                Paper: @Html.Raw(Json.Serialize(ViewBag.PaperList)),
                Ink: @Html.Raw(Json.Serialize(ViewBag.InkList)),
                Supply: @Html.Raw(Json.Serialize(ViewBag.SupplyList)),
                sparePart: @Html.Raw(Json.Serialize(ViewBag.sparepartList))
            };

            $('#itemType').change(function() {
                var type = $(this).val();
                if (type === 'Ink') {
                    $('#unitsFieldDiv, #priceFieldDiv').show();
                    $('#quantityFieldDiv').hide();
                } else {
                    $('#quantityFieldDiv, #priceFieldDiv').show();
                    $('#unitsFieldDiv').hide();
                    $('#NumberOfUnits').val('');
                }

                var $sel = $('#itemId').empty().prop('disabled', !type).append('<option value="">-- اختر --</option>');
                if (!type) return;
                dataSources[type].forEach(function(i) {
                    const id = i.paperId || i.inkId || i.suppliesId || i.sparePartsId;
                    const name = i.name || i.paperName || i.inkName || i.suppliesName || i.sparePartsName;
                    $sel.append($('<option>', { value: id, text: name }));
                });
            });

            function renderItems() {
                $('#itemsTableBody, #hiddenItemsContainer').empty();
                items.forEach(function(it, idx) {
                    $('#itemsTableBody').append(
                        '<tr data-index="' + idx + '">' +
                        '<td>' + it.itemName + '</td>' +
                        '<td>' + it.quantity + '</td>' +
                        '<td>' + it.price.toFixed(2) + '</td>' +
                        '<td>' + (it.numberOfUnits || '') + '</td>' +
                        '<td>' +
                        '<button type="button" class="btn editItem">تعديل</button>' +
                        '<button type="button" class="btn deleteItem">حذف</button>' +
                        '</td>' +
                        '</tr>'
                    );

                    var hidden = [];
                    if (it.itemType === 'Ink') hidden.push('<input type="hidden" name="BridgeList[' + idx + '].InkId" value="' + it.itemId + '" />');
                    if (it.itemType === 'Paper') hidden.push('<input type="hidden" name="BridgeList[' + idx + '].PaperId" value="' + it.itemId + '" />');
                    if (it.itemType === 'Supply') hidden.push('<input type="hidden" name="BridgeList[' + idx + '].SuppliesId" value="' + it.itemId + '" />');
                    if (it.itemType === 'sparePart') hidden.push('<input type="hidden" name="BridgeList[' + idx + '].SparePartsId" value="' + it.itemId + '" />');

                    hidden.push(
                        '<input type="hidden" name="BridgeList[' + idx + '].Quantity" value="' + it.quantity + '" />',
                        '<input type="hidden" name="BridgeList[' + idx + '].NumberOfUnits" value="' + (it.numberOfUnits || '') + '" />',
                        '<input type="hidden" name="BridgeList[' + idx + '].UnitP" value="' + it.uni+ '" />'
                    );

                    $('#hiddenItemsContainer').append(hidden.join(''));
                });
            }

            $('#addItem').click(function() {
                var type = $('#itemType').val(),
                    id = $('#itemId').val(),
                    name = $('#itemId option:selected').text(),
                    qty = parseInt($('#itemQuantity').val()) || 0,
                    units = parseInt($('#NumberOfUnits').val()) || 0,
                    price = parseFloat($('#itemPrice').val()) || 0;

                if (!type || !id || (type !== 'Ink' && (isNaN(qty) || qty <= 0)) || isNaN(price) || price <= 0) {
                    return alert('يرجى تعبئة جميع الحقول بشكل صحيح');
                }

                var obj = {
                    itemType: type,
                    itemId: id,
                    itemName: name,
                    quantity: type === 'Ink' ? 0 : qty,
                    numberOfUnits: type === 'Ink' ? units : 0,
                    price: price
                };

                if (editIndex < 0) {
                    items.push(obj);
                } else {
                    items[editIndex] = obj;
                    editIndex = -1;
                    $('#addItem').text('أضف العنصر');
                }

                $('#itemType').val('');
                $('#itemId').empty().append('<option value="">-- اختر العنصر --</option>').prop('disabled', true);
                $('#itemQuantity, #NumberOfUnits, #itemPrice').val('');
                renderItems();
            });

            $('#itemsTableBody').on('click', '.editItem', function() {
                editIndex = $(this).closest('tr').data('index');
                var it = items[editIndex];
                $('#itemType').val(it.itemType).trigger('change');
                setTimeout(function() {
                    $('#itemId').val(it.itemId);
                }, 0);
                $('#itemQuantity').val(it.quantity);
                $('#NumberOfUnits').val(it.numberOfUnits);
                $('#itemPrice').val(it.price);
                $('#addItem').text('تحديث العنصر');
            });

            $('#itemsTableBody').on('click', '.deleteItem', function() {
                items.splice($(this).closest('tr').data('index'), 1);
                renderItems();
            });

            $('form').submit(function(e) {
                if (!items.length) {
                    alert('يجب إضافة عنصر واحد على الأقل قبل إرسال الطلب.');
                    e.preventDefault();
                }
            });
        });
    </script>
</body>
</html>