@model ThothSystemVersion1.DataTransfereObject.RequisiteOrderDTO

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="LogIn.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="./photos/eye.jpg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@100..900&display=swap" rel="stylesheet" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <title>ThoTh</title>
    <link href="~/css/Technical/Create.css" rel="stylesheet" />
</head>

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white text-center">
            <h4>إنشاء أمر صرف جديد</h4>
        </div>
        <div class="card-body">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success">
                    <i class="bx bx-check-circle"></i> @TempData["SuccessMessage"]
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger">
                    <i class="bx bx-error-circle"></i> @TempData["ErrorMessage"]
                </div>
            }

            <form asp-action="CreateRequisite" asp-controller="Technical" id="myform" class="form-container" method="post">
                <div class="arrow mb-3">
                    <a asp-controller="Admin" asp-action="AdminHome" class="back">
                        <i class='bx bx-left-arrow-circle' style="font-size: 40px; color: #0d6efd;"></i>
                    </a>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label asp-for="JobOrderId" class="form-label fw-bold">اختر الطلبيّة</label>
                        <select asp-for="JobOrderId" class="form-select">
                            <option value="">-- اختر الطلبية --</option>
                            @foreach (var job in ViewBag.JobOrderList)
                            {
                                <option value="@job.JobOrderId">
                                    @job.JobOrderId - @(job.Customer?.CustomerName ?? "بدون عميل")
                                   
                                </option>
                            }
                        </select>
                        <span asp-validation-for="JobOrderId" class="text-danger"></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <label asp-for="RequisiteNotes" class="form-label fw-bold">إضافة ملاحظات</label>
                        <textarea asp-for="RequisiteNotes" class="form-control" rows="2"></textarea>
                    </div>
                </div>

                <div class="card mt-4 border-primary shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">إضافة صنف</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">نوع الصنف</label>
                                <select id="itemType" class="form-select">
                                    <option value="">-- اختر النوع --</option>
                                    <option value="Paper">ورق</option>
                                    <option value="Ink">حبر</option>
                                    <option value="Supply">مستلزمات</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">الصنف</label>
                                <select id="itemId" class="form-select" disabled>
                                    <option value="">-- اختر الصنف --</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">الكمية</label>
                                <input type="number" id="itemQuantity" class="form-control" min="1" />
                            </div>

                            <div class="col-md-1 d-grid">
                                <button type="button" id="addItem" class="btn btn-primary mt-4">إضافة</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive mt-4">
                    <table class="table table-bordered table-hover text-center">
                        <thead class="table-primary">
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <!-- Dynamic rows will be added here -->
                        </tbody>
                    </table>
                </div>

                <!-- Hidden inputs for BridgeList -->
                <div id="hiddenItemsContainer"></div>

                <div class="d-grid mt-3">
                    <button type="submit" class="btn btn-success btn-lg">حفظ الطلب</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var items = [];
            var editIndex = -1;

            // Use ViewBag data for JavaScript
            const dataSources = {
                Paper: @Html.Raw(Json.Serialize(ViewBag.PaperList)),
                Ink: @Html.Raw(Json.Serialize(ViewBag.InkList)),
                Supply: @Html.Raw(Json.Serialize(ViewBag.SupplyList))
            };

            $('#itemType').change(function () {
                var selectedType = $(this).val();
                var $itemSelect = $('#itemId');
                $itemSelect.empty().prop('disabled', !selectedType);

                $itemSelect.append('<option value="">-- اختر --</option>');
                if (!selectedType) return;

                dataSources[selectedType]?.forEach(item => {
                    const id = item.paperId || item.inkId || item.suppliesId;
                    const name = item.name;
                    $itemSelect.append(`<option value="${id}">${name}</option>`);
                });
            });

            function renderItems() {
                var $tableBody = $('#itemsTableBody');
                var $hiddenContainer = $('#hiddenItemsContainer');
                $tableBody.empty();
                $hiddenContainer.empty();

                items.forEach((item, index) => {
                    $tableBody.append(`
                        <tr data-index="${index}">
                            <td>${item.itemName}</td>
                            <td>${item.quantity}</td>
                            <td>
                                <button type="button" class="btn btn-warning btn-sm editItem">تعديل</button>
                                <button type="button" class="btn btn-danger btn-sm deleteItem">حذف</button>
                            </td>
                        </tr>
                    `);

                    let hidden = "";
                    if (item.itemType === "Paper")
                        hidden += `<input type="hidden" name="BridgeList[${index}].PaperId" value="${item.itemId}" />`;
                    else if (item.itemType === "Ink")
                        hidden += `<input type="hidden" name="BridgeList[${index}].InkId" value="${item.itemId}" />`;
                    else if (item.itemType === "Supply")
                        hidden += `<input type="hidden" name="BridgeList[${index}].SuppliesId" value="${item.itemId}" />`;

                    hidden += `<input type="hidden" name="BridgeList[${index}].Quantity" value="${item.quantity}" />`;

                    $hiddenContainer.append(hidden);
                });
            }

            $('#addItem').click(function () {
                var itemType = $('#itemType').val();
                var itemId = $('#itemId').val();
                var itemName = $('#itemId option:selected').text();
                var quantity = $('#itemQuantity').val();

                if (!itemType || !itemId || !quantity || quantity <= 0) {
                    alert("يرجى تعبئة جميع الحقول بشكل صحيح");
                    return;
                }

                var newItem = { itemType, itemId, itemName, quantity };

                if (editIndex === -1) {
                    items.push(newItem);
                } else {
                    items[editIndex] = newItem;
                    editIndex = -1;
                    $('#addItem').text('إضافة');
                }

                $('#itemType').val('');
                $('#itemId').empty().append('<option value="">-- اختر الصنف --</option>').prop('disabled', true);
                $('#itemQuantity').val('');

                renderItems();
            });

            $('#itemsTableBody').on('click', '.editItem', function () {
                editIndex = $(this).closest('tr').data('index');
                var item = items[editIndex];

                $('#itemType').val(item.itemType).trigger('change');
                setTimeout(() => $('#itemId').val(item.itemId), 100);
                $('#itemQuantity').val(item.quantity);
                $('#addItem').text('تحديث');
            });

            $('#itemsTableBody').on('click', '.deleteItem', function () {
                items.splice($(this).closest('tr').data('index'), 1);
                renderItems();
            });

            $('#myform').submit(function (e) {
                if (items.length === 0) {
                    alert("يجب إضافة صنف واحد على الأقل قبل حفظ الطلب");
                    e.preventDefault();
                    return;
                }

                if ($('#JobOrderId').val() === '') {
                    alert("برجاء اختيار الطلبية");
                    e.preventDefault();
                    return;
                }
            });

        @if (TempData["SuccessMessage"] != null)
        {
            <text>
                        setTimeout(function () {
                            window.location.href = '@Url.Action("CreateRequisite")';
                        }, 3000);
            </text>
        }
        });
    </script>
}